#!/usr/bin/env sh
# vim: set ft=sh ai ts=2 sw=2 nowrap:
#
# Normalizes "Insights" downloaded from a group.

set -e # Stops when an error occurs

if [ -n "${DEBUG}" ] # $DEBUG is not emoty
then
	set -x # Outputs commands being executed
fi

# Name of git remote to use
REMOTE=origin
# Git reference to reset (update) repository to
BRANCH=main

if [ -z "$(command -v git)" ]
then
	echo "Error: git is not available." >&2
	exit 2
fi

if [ -z "$(git config user.email)" ]
then 
	echo "Error: git user.email is undefined." >&2
	exit 3
fi

git stash save --quiet --all "auto-generated by git-push"
git fetch --all --quiet
git reset --hard "${REMOTE}/${BRANCH}"
git stash pop --quiet > /dev/null
git add --all -- "data/*.csv"
git commit -F- <<-EOF
	Updated Group Insights data

	Data was manually downloaded from the group, it contains the last
	28 days of activity in the group.
	Files were not manipulated after being downloaded.

	This message was generated from a script.
	EOF
git push --quiet "${REMOTE}" "${BRANCH}"
